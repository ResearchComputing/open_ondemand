set -x

# Find available port to run server on
port=$(find_port ${host})

# make directory that will hold all RStudio content
mkdir /projects/$USER/.rstudioserver

# create Apptainer as symlink so we can use them
if [[ ! -e ~/.apptainer ]]; then
	mkdir -p ~/work/..apptainer
	ln -sr ~/work/.apptainer ~/.apptainer
fi

# export environment variables for Apptainer items 
export APPTAINER_TMPDIR=/projects/$USER/.rstudioserver
export APPTAINER_CACHEDIR=/projects/$USER/.rstudioserver
export RSTUDIO_SERVER_IMAGE=/curc/sw/containers/open_ondemand/<%= context.apptainer_image %>

# create overlay if it doesn't exist and add it to the user's projects directory
if ! test -f "/projects/$USER/.rstudioserver/rstudio-server-4.2.2_overlay.img"; then

	cd /projects/$USER/.rstudioserver
	apptainer overlay create --fakeroot --sparse --size 100000 rstudio-server-4.2.2_overlay.img

fi

# set environment variable for overlay and image so they can be used later
export APPTAINER_OVERLAY=/projects/$USER/.rstudioserver/rstudio-server-4.2.2_overlay.img
export RSTUDIO_SERVER_IMAGE=/curc/sw/containers/open_ondemand/<%= context.apptainer_image %>

<%-
  require 'securerandom'
  csrftoken = SecureRandom.uuid
-%>
export csrf_token="<%= csrftoken %>"
